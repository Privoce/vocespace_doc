import { Tab, Tabs } from "@theme";

# Локальное развертывание Docker

> [!WARNING]
> Обратите внимание: Локальное развертывание позволяет испытать все функции VoceSpace, но недоступно в публичной сети. Если вам нужно публичное развертывание, обратитесь к:
> 1. Docker + Nginx
> 2. Docker + Caddy

## 1. Установка Docker (Docker Engine|Desktop)

> [!INFO]
>
> Для получения подробной информации об установке Docker или при возникновении проблем обратитесь к:
>
> 1. [Docker Engine Install](https://docs.docker.com/engine/install)
> 2. [Docker Desktop Install](https://docs.docker.com/desktop/)
>
> **Если вы новичок и не знакомы с командной строкой, мы рекомендуем установить Docker Desktop.**
>
> **В приведенной ниже установке, если вы используете macOS или Windows, мы проведем вас через установку Docker Desktop.**

<Tabs>
    <Tab label="Macos" style={{padding: "16px"}}>
        <p>
            [Macos-M серия чипов](https://desktop.docker.com/mac/main/arm64/Docker.dmg?utm_source=docker&utm_medium=webreferral&utm_campaign=dd-smartbutton&utm_location=module&_gl=1*ka9maz*_gcl_au*NTM4NzM2Njg3LjE3NDcxMzAyMTA.*_ga*MTk1NDA1MTg1NS4xNzMzMzA0NDc0*_ga_XJWPQMJYHQ*czE3NDcxMzAyMTAkbzUkZzEkdDE3NDcxMzA5NDgkajQzJGwwJGgw)
        </p>
        <p>
            [Macos-Intel серия чипов](https://desktop.docker.com/mac/main/amd64/Docker.dmg?utm_source=docker&utm_medium=webreferral&utm_campaign=dd-smartbutton&utm_location=module&_gl=1*f8qjhp*_gcl_au*NTM4NzM2Njg3LjE3NDcxMzAyMTA.*_ga*MTk1NDA1MTg1NS4xNzMzMzA0NDc0*_ga_XJWPQMJYHQ*czE3NDcxMzAyMTAkbzUkZzEkdDE3NDcxMzEwNzEkajYwJGwwJGgw)
        </p>
    </Tab>
    <Tab label="Windows" style={{padding: "16px"}}>
       <p>
         [Windows-AMD64](https://desktop.docker.com/win/main/amd64/Docker%20Desktop%20Installer.exe?utm_source=docker&utm_medium=webreferral&utm_campaign=dd-smartbutton&utm_location=module&_gl=1*e61e0o*_gcl_au*NTM4NzM2Njg3LjE3NDcxMzAyMTA.*_ga*MTk1NDA1MTg1NS4xNzMzMzA0NDc0*_ga_XJWPQMJYHQ*czE3NDcxMzAyMTAkbzUkZzEkdDE3NDcxMzEwNzEkajYwJGwwJGgw)
       </p>
       <p>
        [Windows-ARM64](https://desktop.docker.com/win/main/arm64/Docker%20Desktop%20Installer.exe?utm_source=docker&utm_medium=webreferral&utm_campaign=dd-smartbutton&utm_location=module&_gl=1*gz6juv*_gcl_au*NTM4NzM2Njg3LjE3NDcxMzAyMTA.*_ga*MTk1NDA1MTg1NS4xNzMzMzA0NDc0*_ga_XJWPQMJYHQ*czE3NDcxMzAyMTAkbzUkZzEkdDE3NDcxMzEwNzEkajYwJGwwJGgw)
       </p>
    </Tab>
    <Tab label="Linux(Ubuntu)" style={{padding: "0 16px"}}>
### Полное удаление старой версии и ресурсов
 ```bash
sudo apt-get purge docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin docker-ce-rootless-extras
sudo rm -rf /var/lib/docker
sudo rm -rf /var/lib/containerd
sudo rm /etc/apt/sources.list.d/docker.list
sudo rm /etc/apt/keyrings/docker.asc
```
### Обновление и инициализация репозитория Docker apt
```bash
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc
```
### Добавление репозитория в источники apt
```bash
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
```
### Установка последней версии Docker
```bash
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
# Проверьте установку
sudo docker run hello-world
```
    </Tab>

</Tabs>

## 2. Получение образа VoceSpace

VoceSpace имеет два типа образов:
- amd: `privoce/vocespace:latest`
- arm: `privoce/vocespace:latest_arm`

Поэтому вам нужно знать архитектуру вашего сервера для выбора, см.: [help-просмотр архитектуры linux](/zh/doc/deploy/help#查看自己的linux架构)

```shell
# amd
docker pull privoce/vocespace:latest
# arm
docker pull privoce/vocespace:latest_arm
```

## 3. Копирование базовой конфигурации

Ниже приведена базовая конфигурация VoceSpace. Перед запуском контейнера вам нужно скопировать эту конфигурацию и указать её при запуске

```json
{
  "livekit": {
    "key": "devkey",
    "secret": "secret",
    "url": "wss://your.server.name" // modify ⚠️
  },
  "codec": "vp9",
  "resolution": "1080p",
  "maxBitrate": 3000000,
  "maxFramerate": 30,
  "priority": "medium",
  "redis": { 
    "enabled": true, 
    "host": "your.ip",  // modify ⚠️
    "port": 6379, 
    "password": "vocespace", 
    "db": 0 
  },
  "serverUrl": "your.server.name", // modify ⚠️
  "hostToken": "vocespace",
  "license": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6ImhhbkBwcml2b2NlLmNvbSIsImV4cGlyZXNfYXQiOjQ4OTEzMzQ0MDAsImNyZWF0ZWRfYXQiOjE3MzU2NjA4MDAsImRvbWFpbnMiOiIqIiwibGltaXQiOiJmcmVlIiwiaWQiOiI2NGUyMjYwZS0xMzQwLTQxNjQtOWNmZC0zMGUwMjhlYTg0ZWQifQ.T0vIHUCxv9j75lb92RDDaegpPO9W9hxWEXqZVidwL0E"
}
```

> [!WARNING]
>
> your.ip: IP-адрес хост-машины пользователя, можно просмотреть с помощью `ifconfig | grep inet`
> ```bash
> inet 127.0.0.1 netmask 0xff000000
> inet 192.168.31.138 netmask 0xffffff00 broadcast 192.168.31.255
> ```
> В этом примере `192.168.31.138` — это IP вашего хоста, для redis можно использовать `localhost`


## 4. Запуск контейнера

```shell
docker run -d \
-p 3000:3000 \
-v ${PWD}/vocespace.conf.json:/app/vocespace.conf.json \
--name vocespace \
privoce/vocespace:latest
```

> [!NOTE]
>
> ⚠️`-v ${PWD}/vocespace.json:/app/vocespace.conf.json`: Монтирование конфигурации


### Вывод

1. Docker CE: Если вы используете Linux, можете использовать `docker ps` для просмотра процессов, затем в браузере перейти к `your_ip:3000` для просмотра запущенного приложения, затем использовать `docker logs <container_id>` для просмотра логов
2. Docker Desktop: После запуска контейнера наблюдайте за выводом. Когда появится `Ready on http://ip:3000`, это означает, что локальное развертывание завершено


```bash
2025-05-29 02:44:09 ✅ Socket.IO установка завершена
2025-05-29 02:44:15 Конфигурация переменных окружения:
2025-05-29 02:44:15 LIVEKIT_API_KEY=devkey
2025-05-29 02:44:15 LIVEKIT_API_SECRET=secret
2025-05-29 02:44:15 LIVEKIT_URL=ws://localhost:7880
2025-05-29 02:44:15 NEXT_PUBLIC_BASE_PATH=
2025-05-29 02:44:15 PORT=3000
2025-05-29 02:44:15 HOST=0.0.0.0
2025-05-29 02:44:15 TURN_CREDENTIAL=
2025-05-29 02:44:15 TURN_URL=
2025-05-29 02:44:15 TURN_USERNAME=
2025-05-29 02:44:15 WEBHOOK=
2025-05-29 02:44:15 === 启动应用 ===
2025-05-29 02:44:16 > Ready on http://0.0.0.0:3000
```

## 4. Запуск livekit-server

VoceSpace требует livekit-server для сборки WebRTC и других связанных сервисов.

### Скачать livekit-server
<Tabs>
    <Tab label="Macos">
    ```bash
    brew update && brew install livekit
    ```
    </Tab>
    <Tab label="Windows" style={{padding: "6px"}}>
        Перейдите на [livekit github](https://github.com/livekit/livekit/releases)
    </Tab>
    <Tab label="Linux">
    ```bash
    curl -sSL https://get.livekit.io | bash
    ```
    </Tab>
</Tabs>

### Запуск livekit-server

```
livekit-server --dev --bind 0.0.0.0
```

## 5. Загрузка и запуск Redis

<Tabs>
    <Tab label="Macos">
    ```bash
    brew install redis
    brew services start redis -- --requirepass "vocespace" --bind 0.0.0.0 --protected-mode no --daemonize yes
    ```
    </Tab>
    <Tab label="Windows" style={{padding: "6px"}}>
        Скачать [Redis-Windows](https://github.com/tporadowski/redis/releases/download/v5.0.14.1/Redis-x64-5.0.14.1.msi)
        ```bash
        redis-server --requirepass "vocespace" --bind 0.0.0.0 --protected-mode no --daemonize yes
        ```
    </Tab>
    <Tab label="Linux">
    ```bash
    apt install redis-server
    redis-server --requirepass "vocespace" --bind 0.0.0.0 --protected-mode no --daemonize yes
    systemctl restart redis
    ```
    </Tab>
</Tabs>

## Примечания для облачных серверов

### Настройка группы безопасности/брандмауэра

При использовании облачных серверов, таких как Alibaba Cloud, Tencent Cloud, Google Cloud и т.д., вам необходимо настроить группу безопасности/брандмауэр сервера

| port | type | ingress/egress | allow ip |
|--|--|--|--|
| 3000 | tcp | ingress | 0.0.0.0/0 Ipv4 |
| 3000 | tcp | egress | 0.0.0.0/0 Ipv4 |
| 7880 | tcp | ingress | 0.0.0.0/0 Ipv4 |
| 7881 | tcp | ingress | 0.0.0.0/0 Ipv4 |
| 80 | tcp | ingress | 0.0.0.0/0 Ipv4 |
