import { Tab, Tabs } from "@theme";

# Docker + Caddy

Caddy is simpler than Nginx because it can automatically apply for certificates.

You need to start the project container first, then install and configure Caddy, otherwise the certificate application may fail.

**[(Optional) How to get key and secret?](./help#how-to-get-key-and-secret)**

## 1. Copy Basic Configuration

The following is the basic configuration of vocespace. You need to copy this configuration and specify it when starting the container

The defaul "key": `"devkey"`, "secret": `"secret"` works well, however, if you want to improve security and stability, feel free to generate a key/secret pair from your hosted livekit-server.

**[(Optional) How to get key and secret?](./help#how-to-get-key-and-secret)**

```json
{
  "livekit": {
    "key": "devkey",
    "secret": "secret",
    "url": "wss://your.server.name" // modify ⚠️
  },
  "codec": "vp9",
  "resolution": "1080p",
  "maxBitrate": 3000000,
  "maxFramerate": 30,
  "priority": "medium",
  "redis": { 
    "enabled": true, 
    "host": "your.ip",  // modify ⚠️
    "port": 6379, 
    "password": "vocespace", 
    "db": 0 
  },
  "server_url": "your.server.name" // modify ⚠️
}
```

> [!WARNING]
>
> `your.ip`: User host machine IP address, you can use `ifconfig | grep inet` to view
> ```bash
> inet 127.0.0.1 netmask 0xff000000
> inet 192.168.31.138 netmask 0xffffff00 broadcast 192.168.31.255
> ```
> In this example `192.168.31.138` is your host machine IP
> 
> `your.server.name`: Domain name for deployment

## 2. Use Docker to deploy applications

### Get VoceSpace Images

VoceSpace contains two images:
- amd: `privoce/vocespace:latest`
- arm: `privoce/vocespace:latest_arm`

So you need to know your current server architecture to make a choice, see: [help-View your own Linux architecture](/doc/deploy/help#check-your-own-linux-architecture)

```shell
# amd
docker pull privoce/vocespace:latest
# arm
docker pull privoce/vocespace:latest_arm
```

### Start Container

You need to start the project container first, then install and configure Caddy, otherwise the certificate application may fail.

```bash
docker run -d \
  -p 3000:3000 \
  -v ${PWD}/vocespace.conf.json:/app/vocespace.conf.json \
  --name vocespace \
  privoce/vocespace:latest
```

> [!NOTE]
>
> * `-p 3000:3000`: Map the container's port 3000 to the host's port 3000.
> * `-v ${PWD}/vocespace.conf.json:/app/vocespace.conf.json`: Map the configuration
> * `--name`: Name the container for easy subsequent management.


## 2. Install and configure Caddy

> [!INFO]
>
> The following is the installation method for Ubuntu/Debian
>
> For other types, please refer to: [Caddy install](https://caddyserver.com/docs/install#debian-ubuntu-raspbian)

### 2.1 Install Caddy

```bash
sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https curl
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
sudo apt update
sudo apt install caddy
```

### 2.2 Configure Caddy

Caddy supports multiple configuration methods, and also directly supports the use of nginx conf

> [!WARNING]
>
> Please make sure you have purchased the domain name and performed DNS resolution


```bash
vim /etc/caddy/Caddyfile
```

```nginx
your.server.name { # modify ⚠️
    # webrtc
    handle /rtc* {
        reverse_proxy localhost:7880 {
            header_up Host {host}
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    handle /socket.io/* {
        reverse_proxy localhost:3000 {
            header_up Host {host}
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # main app https
    handle {
        reverse_proxy localhost:3000 {
            header_up Host {host}
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # log optional
    #log {
    #    output file /var/log/caddy/your.server.name.log
    #    level DEBUG
    #}
}
```




## 3. Start livekit-server

Like local deployment, you also need to start livekit-server to support webrtc. You can choose to download livekit and start it as in local deployment, or you can use docker deployment

<Tabs>
  <Tab label="Local">
    ### Download livekit-server
    
    ```bash
    curl -sSL https://get.livekit.io | bash
    ```
    
   After the download is completed, it will usually be in `/usr/local/bin/livekit-server`

    ### Create configuration
    We provide a minimal configuration to help you deploy quickly. First, create the configuration file `vim /etc/livekit.yml`
    ```yml
    port: 7880
    bind_addresses:
        - "0.0.0.0"
    rtc:
        tcp_port: 7881
        port_range_start: 50000
        port_range_end: 60000
        use_external_ip: true
        enable_loopback_candidate: false
    turn:
        enabled: false
        domain: turn.vocespace.xyz
        tls_port: 5349
        udp_port: 3478
        external_tls: true
    keys:
      devkey: secret
    ```

    ### Start in the background using nohup

    By using nohup you can start livekit-server in the background and output the logs to `/usr/local/bin/logs/livekit_output.log` for easy viewing
    
    ```bash
    nohup /usr/local/bin/livekit-server --config /etc/livekit.yml > /usr/local/bin/logs/livekit_output.log 2>&1 &
    ```


  </Tab>
  <Tab label="Docker">
  ### docker pull livekit-server
  ```bash
  docker pull livekit/livekit-server:latest
  ```
    ### Create configuration
    We provide a minimal configuration to help you deploy quickly. First, create the configuration file `vim /etc/livekit.yml`
    ```yml
    port: 7880
    bind_addresses:
        - "0.0.0.0"
    rtc:
        tcp_port: 7881
        port_range_start: 50000
        port_range_end: 60000
        use_external_ip: true
        enable_loopback_candidate: false
    turn:
        enabled: false
        domain: turn.vocespace.xyz
        tls_port: 5349
        udp_port: 3478
        external_tls: true
    keys:
      devkey: secret
    ```

    ### Run livekit-server

    Also use the configuration file

    ```bash
    docker run -d \
      --network host \
      --name livekit-server \
      -v /etc/livekit.yml:/etc/livekit.yaml \
      livekit/livekit-server \
      --config /etc/livekit.yaml
    ```
    You can also choose not to use the host method and map ports one by one, but this will take a long time
    ```bash
    docker run -d \
      --name livekit-server \
      -p 7880:7880 \
      -p 50000-60000:50000-60000/udp \
      livekit/livekit-server \
      --config /etc/livekit.yaml
    ```
  </Tab>
</Tabs>

## 4. Download and start Redis

<Tabs>
    <Tab label="Macos">
    ```bash
    brew install redis
    brew services start redis -- --requirepass "vocespace" --bind 0.0.0.0 --protected-mode no
    ```
    </Tab>
    <Tab label="Windows" style={{padding: "6px"}}>
        Click to download [Redis-Windows](https://github.com/tporadowski/redis/releases/download/v5.0.14.1/Redis-x64-5.0.14.1.msi)
        ```bash
        redis-server --requirepass "vocespace" --bind 0.0.0.0 --protected-mode no
        ```
    </Tab>
    <Tab label="Linux">
    ```bash
    apt install redis-server
    redis-server --requirepass "vocespace" --bind 0.0.0.0 --protected-mode no
    systemctl restart redis
    ```
    </Tab>
</Tabs>

### Restart and enable Caddy

```bash
systemctl stop caddy
systemctl enabled caddy
systemctl start caddy
```

## Cloud Server Description

### Configure Security Group/Firewall

When using cloud servers, such as Alibaba Cloud, Tencent Cloud, Google Cloud, etc., you need to configure the security group/firewall of the server.

| port        | type | ingress/egress | allow ip       |
| ----------- | ---- | -------------- | -------------- |
| 3000        | tcp  | ingress        | 0.0.0.0/0 Ipv4 |
| 3000        | tcp  | egress         | 0.0.0.0/0 Ipv4 |
| 7880        | tcp  | ingress        | 0.0.0.0/0 Ipv4 |
| 7881        | tcp  | ingress        | 0.0.0.0/0 Ipv4 |
| 80          | tcp  | ingress        | 0.0.0.0/0 Ipv4 |
| 443         | tcp  | ingress        | 0.0.0.0/0 Ipv4 |
| 50000~60000 | udp  | ingress        | 0.0.0.0/0 Ipv4 |

### Restart and enabled Caddy

```bash
systemctl stop caddy
systemctl enabled caddy
systemctl start caddy
```